<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DTSEN Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- AdminLTE + Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Dashboard DTSEN</a>
      </li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link">
      <i class="fas fa-database ml-2"></i>
      <span class="brand-text font-weight-light">Monitoring DTSEN</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <li class="nav-item">
            <a href="#overview" class="nav-link active" data-toggle="tab">
              <i class="nav-icon fas fa-chart-line"></i>
              <p>Overview</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#daftar-surat" class="nav-link" data-toggle="tab">
              <i class="nav-icon fas fa-envelope-open-text"></i>
              <p>Daftar Surat</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#statistik" class="nav-link" data-toggle="tab">
              <i class="nav-icon fas fa-chart-pie"></i>
              <p>Statistik</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <div class="tab-content p-3">

      <!-- Overview -->
      <div class="tab-pane fade show active" id="overview">
        <div class="row">
          <!-- Jumlah Lembaga -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-primary">
              <div class="inner">
                <h3 id="totalLembaga">0</h3>
                <p>Jumlah Lembaga</p>
              </div>
              <div class="icon">
                <i class="fas fa-landmark"></i>
              </div>
            </div>
          </div>
          <!-- Jumlah Surat -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
              <div class="inner">
                <h3 id="totalSurat">0</h3>
                <p>Jumlah Surat</p>
              </div>
              <div class="icon">
                <i class="fas fa-envelope"></i>
              </div>
            </div>
          </div>
          <!-- BAST Selesai -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
              <div class="inner">
                <h3 id="totalBAST">0</h3>
                <p>BAST Selesai</p>
              </div>
              <div class="icon">
                <i class="fas fa-file-signature"></i>
              </div>
            </div>
          </div>
          <!-- On Progress -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
              <div class="inner">
                <h3 id="onProgress">0</h3>
                <p>On Progress</p>
              </div>
              <div class="icon">
                <i class="fas fa-spinner"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Daftar Surat -->
      <div class="tab-pane fade" id="daftar-surat">
        <h4>Daftar Surat Terbaru</h4>
        <table class="table table-bordered" id="tabelSurat">
          <thead>
            <tr>
              <th>No</th>
              <th>Tanggal</th>
              <th>Lembaga</th>
              <th>BAST</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Statistik -->
      <div class="tab-pane fade" id="statistik">
        <h4>Statistik</h4>
        <p>Grafik atau chart bisa ditaruh di sini.</p>
      </div>

    </div>
  </div>

</div>

  
  
<!-- ======= SCRIPT & STYLE untuk fetch + parsing ======= -->
<script>
// === Konfigurasi Google Sheet ===
const SHEET_ID = "1fpkO2nodFJNPp71C12LZLxsqsJ8rt9G-wRVSwwugwoc";
const SHEET_GID = "0";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

const START_ROW = null; // auto-detect baris pertama

// Map variasi nama bulan lokal ke English
const MONTH_MAP = {
  'jan':'Jan','januari':'Jan',
  'feb':'Feb','februari':'Feb',
  'mar':'Mar','maret':'Mar',
  'apr':'Apr','april':'Apr',
  'mei':'May','may':'May',
  'jun':'Jun','juni':'Jun',
  'jul':'Jul','juli':'Jul',
  'aug':'Aug','agust':'Aug','agu':'Aug',
  'sep':'Sep','sept':'Sep','september':'Sep',
  'okt':'Oct','oktober':'Oct','oct':'Oct',
  'nov':'Nov','november':'Nov',
  'dec':'Dec','desember':'Dec','dec':'Dec'
};

// Parsing tanggal sederhana tapi fleksibel
function normalizeAndParseDate(raw){
  if(!raw && raw!==0) return null;
  let s = String(raw).trim().replace(/[-.,]/g,' ');
  for(const k in MONTH_MAP){
    const re = new RegExp('(^|[^a-zA-Z])'+k+'([^a-zA-Z]|$)','i');
    s = s.replace(re,'$1'+MONTH_MAP[k]+'$2');
  }
  let t = Date.parse(s);
  if(!isNaN(t)) return new Date(t);

  // dd MMM yy / yyyy
  const m = s.match(/(\d{1,2})\s+([A-Za-z]{3,})\s+(\d{2,4})/);
  if(m){
    const day = parseInt(m[1],10);
    const monStr = m[2];
    let year = parseInt(m[3],10);
    if(year<100) year+=2000;
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const monIndex = months.findIndex(x=>x.toLowerCase()===monStr.toLowerCase());
    if(monIndex>=0) return new Date(year,monIndex,day);
  }
  return null;
}

function formatDateShort(d){
  if(!d) return "";
  const day = String(d.getDate()).padStart(2,'0');
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  return `${day} ${months[d.getMonth()]} ${d.getFullYear()}`;
}

function mapStatus(raw){
  if(!raw || String(raw).trim()==="") return {display:"-",done:false};
  const s = String(raw).trim().toLowerCase();
  const okSet = new Set(["v","✔","✓","ok","ya","yes","done","true","terkirim"]);
  if(okSet.has(s) || s.includes("bast") || s.includes("selesai")) return {display:"OK",done:true};
  return {display:String(raw),done:false};
}

// helper safe-get
const getCellValue = cell => {
  if(!cell) return "";
  return ('v' in cell && cell.v!=null)?cell.v:(cell.f||"");
};

fetch(SHEET_URL)
  .then(res=>res.text())
  .then(txt=>{
    try{
      const json = JSON.parse(txt.substr(47).slice(0,-2));
      const rows = json.table.rows||[];
      let startIdx = 0;
      if(START_ROW!==null) startIdx = START_ROW;
      else {
        for(let i=0;i<rows.length;i++){
          const r = rows[i];
          const no = getCellValue(r.c[0]);
          if(no.trim()!==""){startIdx=i;break;}
        }
      }

      const dataRows = rows.slice(startIdx);
      const tbody = document.querySelector("#tabelSurat tbody");
      tbody.innerHTML="";

      let totalSurat=0;
      let totalBAST=0;
      let lembagaSet = new Set();

      dataRows.forEach(r=>{
        const noSurat = getCellValue(r.c[0]);
        const lembagaRaw = getCellValue(r.c[1]);
        const tglRaw = getCellValue(r.c[2]);
        const statusRaw = getCellValue(r.c[8]);

        const parsedDate = normalizeAndParseDate(tglRaw);
        const tglDisplay = parsedDate?formatDateShort(parsedDate):String(tglRaw||"").trim();

        const mapped = mapStatus(statusRaw);

        if(noSurat.trim()!=="") totalSurat++;
        if(mapped.done) totalBAST++;
        if(lembagaRaw) lembagaSet.add(lembagaRaw.trim());

        const tr = `<tr>
          <td>${noSurat}</td>
          <td>${tglDisplay}</td>
          <td>${lembagaRaw}</td>
          <td>${mapped.display}</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend',tr);
      });

      document.getElementById("totalLembaga").innerText = lembagaSet.size;
      document.getElementById("totalSurat").innerText = totalSurat;
      document.getElementById("totalBAST").innerText = totalBAST;
      document.getElementById("onProgress").innerText = totalSurat - totalBAST;

    }catch(e){console.error(e);}
  })
  .catch(err=>console.error(err));
</script>



<style>
/* Tabel header & striping */
#tabelSurat thead {
  background-color: #0d6efd; /* bootstrap primary */
  color: white;
}
#tabelSurat tbody tr:nth-child(even) {
  background-color: #f2f8ff;
}
#tabelSurat tbody tr:nth-child(odd) {
  background-color: #ffffff;
}
#tabelSurat tbody tr:hover {
  background-color: #e6f2ff;
}
</style>


</body>
</html>

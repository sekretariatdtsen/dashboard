<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DTSEN Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- AdminLTE + Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Dashboard DTSEN</a>
      </li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link">
      <i class="fas fa-database ml-2"></i>
      <span class="brand-text font-weight-light">Monitoring DTSEN</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <li class="nav-item">
            <a href="#overview" class="nav-link active" data-toggle="tab">
              <i class="nav-icon fas fa-chart-line"></i>
              <p>Overview</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#daftar-surat" class="nav-link" data-toggle="tab">
              <i class="nav-icon fas fa-envelope-open-text"></i>
              <p>Daftar Surat</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#statistik" class="nav-link" data-toggle="tab">
              <i class="nav-icon fas fa-chart-pie"></i>
              <p>Statistik</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <div class="tab-content p-3">

      <!-- Overview -->
      <div class="tab-pane fade show active" id="overview">
        <div class="row">
          <!-- Jumlah Lembaga -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-primary">
              <div class="inner">
                <h3 id="totalLembaga">0</h3>
                <p>Jumlah Lembaga</p>
              </div>
              <div class="icon">
                <i class="fas fa-landmark"></i>
              </div>
            </div>
          </div>
          <!-- Jumlah Surat -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
              <div class="inner">
                <h3 id="totalSurat">0</h3>
                <p>Jumlah Surat</p>
              </div>
              <div class="icon">
                <i class="fas fa-envelope"></i>
              </div>
            </div>
          </div>
          <!-- BAST Selesai -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
              <div class="inner">
                <h3 id="totalBAST">0</h3>
                <p>BAST Selesai</p>
              </div>
              <div class="icon">
                <i class="fas fa-file-signature"></i>
              </div>
            </div>
          </div>
          <!-- On Progress -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
              <div class="inner">
                <h3 id="onProgress">0</h3>
                <p>On Progress</p>
              </div>
              <div class="icon">
                <i class="fas fa-spinner"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Daftar Surat -->
      <div class="tab-pane fade" id="daftar-surat">
        <h4>Daftar Surat Terbaru</h4>
        <table class="table table-bordered" id="tabelSurat">
          <thead>
            <tr>
              <th>No</th>
              <th>Tanggal</th>
              <th>Lembaga</th>
              <th>BAST</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Statistik -->
      <div class="tab-pane fade" id="statistik">
        <h4>Statistik</h4>
        <p>Grafik atau chart bisa ditaruh di sini.</p>
      </div>

    </div>
  </div>

</div>

<script>
// === Konfigurasi Google Sheet ===
const SHEET_ID = "1fpkO2nodFJNPp71C12LZLxsqsJ8rt9G-wRVSwwugwoc"; // ID sheet
const SHEET_GID = "0"; // gid tab sheet
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

// Fungsi normalisasi tanggal (akomodir variasi nama bulan)
function normalizeDate(str) {
  if (!str) return "";
  let mapBulan = {
    jan: "Jan", januari: "Jan",
    feb: "Feb", februari: "Feb",
    mar: "Mar", maret: "Mar",
    apr: "Apr", april: "Apr",
    mei: "May", may: "May",
    jun: "Jun", juni: "Jun",
    jul: "Jul", juli: "Jul",
    aug: "Aug", agust: "Aug", agustus: "Aug", agu: "Aug",
    sep: "Sep", sept: "Sep", september: "Sep",
    oct: "Oct", oktober: "Oct",
    nov: "Nov", november: "Nov",
    dec: "Dec", desember: "Dec"
  };
  let lower = str.toLowerCase();
  for (let key in mapBulan) {
    if (lower.includes(key)) {
      return str.replace(new RegExp(key, "i"), mapBulan[key]);
    }
  }
  return str;
}

fetch(SHEET_URL)
  .then(res => res.text())
  .then(txt => {
    const json = JSON.parse(txt.substr(47).slice(0, -2)); // parse gviz json
    const rows = json.table.rows;

    // ðŸ‘‰ mulai dari baris ke-x+1 sheet (karena rows[] hanya isi yg ada data)
    const dataRows = rows.slice(6);

    let totalSurat = 0;   // dihitung dari kolom Tanggal
    let totalBAST = 0;    // jumlah yg status = v
    let onProgress = 0;   // jumlah yg status kosong
    let lembagaSet = new Set();

    let tbody = document.querySelector("#tabelSurat tbody");
    tbody.innerHTML = "";

    dataRows.forEach(r => {
      let noSurat = r.c[1] ? r.c[1].v : "";
      let tglRaw = r.c[3] ? r.c[3].f || r.c[3].v : "";
      let tgl = normalizeDate(tglRaw);
      let lembaga = r.c[2] ? r.c[2].v : "";
      let statusRaw = r.c[9] ? r.c[9].v : "";
      let status = statusRaw === "v" ? "OK" : "â€“";

      // Hitung jumlah surat berdasarkan tanggal ada isinya
      if (lembaga) totalSurat++;

      // Hitung BAST Selesai / On Progress
      if (statusRaw === "v") {
        totalBAST++;
      } else {
        onProgress++;
      }

      // Hitung lembaga unik
      if (lembaga) lembagaSet.add(lembaga);

      // Tambah ke tabel
      let tr = `<tr>
        <td>${noSurat}</td>
        <td>${tgl}</td>
        <td>${lembaga}</td>
        <td>${status}</td>
      </tr>`;
      tbody.innerHTML += tr;
    });

    // Update Score Cards
    document.getElementById("totalLembaga").innerText = lembagaSet.size;
    document.getElementById("totalSurat").innerText = totalSurat;
    document.getElementById("totalBAST").innerText = totalBAST;
    document.getElementById("onProgress").innerText = onProgress;
  })
  .catch(err => console.error("Error fetch sheet:", err));
</script>

<style>
/* Styling tabel */
#tabelSurat thead {
  background-color: #007bff;
  color: white;
}
#tabelSurat tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}
#tabelSurat tbody tr:nth-child(odd) {
  background-color: #ffffff;
}
</style>


</body>
</html>

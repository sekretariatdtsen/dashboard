<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>DTSEN Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- AdminLTE + Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/css/adminlte.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/admin-lte@3.2/dist/js/adminlte.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">

  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#"><i class="fas fa-bars"></i></a>
      </li>
      <li class="nav-item d-none d-sm-inline-block">
        <a href="#" class="nav-link">Dashboard DTSEN</a>
      </li>
    </ul>
  </nav>

  <!-- Sidebar -->
  <aside class="main-sidebar sidebar-dark-primary elevation-4">
    <a href="#" class="brand-link">
      <i class="fas fa-database ml-2"></i>
      <span class="brand-text font-weight-light">Monitoring DTSEN</span>
    </a>
    <div class="sidebar">
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu">
          <li class="nav-item">
            <a href="#overview" class="nav-link active" data-toggle="tab">
              <i class="nav-icon fas fa-chart-line"></i>
              <p>Overview</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#daftar-surat" class="nav-link" data-toggle="tab">
              <i class="nav-icon fas fa-envelope-open-text"></i>
              <p>Daftar Surat</p>
            </a>
          </li>
          <li class="nav-item">
            <a href="#statistik" class="nav-link" data-toggle="tab">
              <i class="nav-icon fas fa-chart-pie"></i>
              <p>Statistik</p>
            </a>
          </li>
        </ul>
      </nav>
    </div>
  </aside>

  <!-- Content Wrapper -->
  <div class="content-wrapper">
    <div class="tab-content p-3">

      <!-- Overview -->
      <div class="tab-pane fade show active" id="overview">
        <div class="row">
          <!-- Jumlah Lembaga -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-primary">
              <div class="inner">
                <h3 id="totalLembaga">0</h3>
                <p>Jumlah Lembaga</p>
              </div>
              <div class="icon">
                <i class="fas fa-landmark"></i>
              </div>
            </div>
          </div>
          <!-- Jumlah Surat -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-warning">
              <div class="inner">
                <h3 id="totalSurat">0</h3>
                <p>Jumlah Surat</p>
              </div>
              <div class="icon">
                <i class="fas fa-envelope"></i>
              </div>
            </div>
          </div>
          <!-- BAST Selesai -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-success">
              <div class="inner">
                <h3 id="totalBAST">0</h3>
                <p>BAST Selesai</p>
              </div>
              <div class="icon">
                <i class="fas fa-file-signature"></i>
              </div>
            </div>
          </div>
          <!-- On Progress -->
          <div class="col-lg-3 col-6">
            <div class="small-box bg-danger">
              <div class="inner">
                <h3 id="onProgress">0</h3>
                <p>On Progress</p>
              </div>
              <div class="icon">
                <i class="fas fa-spinner"></i>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Daftar Surat -->
      <div class="tab-pane fade" id="daftar-surat">
        <h4>Daftar Surat Terbaru</h4>
        <table class="table table-bordered" id="tabelSurat">
          <thead>
            <tr>
              <th>No</th>
              <th>Tanggal</th>
              <th>Lembaga</th>
              <th>BAST</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Statistik -->
      <div class="tab-pane fade" id="statistik">
        <h4>Statistik</h4>
        <p>Grafik atau chart bisa ditaruh di sini.</p>
      </div>

    </div>
  </div>

</div>

<!-- ======= SCRIPT & STYLE untuk fetch + parsing ======= -->
<script>
// === Konfigurasi Google Sheet ===
const SHEET_ID = "1fpkO2nodFJNPp71C12LZLxsqsJ8rt9G-wRVSwwugwoc";
const SHEET_GID = "0";
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

// Jika mau paksa mulai dari baris ke-n (0-based pada array rows[]),
// set START_ROW ke angka (misal 8 untuk mulai dari rows[8]).
// Kalau null -> auto-detect baris pertama yang berisi kolom penting.
const START_ROW = null; // contoh: 8  atau null (auto)

// Map variasi nama bulan ke format yg bisa diparse oleh Date
const MONTH_MAP = {
  'jan':'Jan','januari':'Jan',
  'feb':'Feb','februari':'Feb',
  'mar':'Mar','maret':'Mar',
  'apr':'Apr','april':'Apr',
  'mei':'May','may':'May',
  'jun':'Jun','juni':'Jun',
  'jul':'Jul','juli':'Jul',
  'aug':'Aug','agust':'Aug','agustus':'Aug','agu':'Aug',
  'sep':'Sep','sept':'Sep','september':'Sep',
  'okt':'Oct','oktober':'Oct','oct':'Oct',
  'nov':'Nov','november':'Nov',
  'dec':'Dec','desember':'Dec','dec':'Dec'
};

function tryParseExcelSerial(serial) {
  // beberapa sheet bisa mengembalikan number sebagai days since 1899-12-30
  // konversi sederhana (tanpa memperhitungkan excel 1900-bug) – biasanya bekerja untuk google sheets numeric dates
  const base = Date.UTC(1899,11,30); // 1899-12-30
  const ms = Number(serial) * 24 * 3600 * 1000;
  if (isNaN(ms)) return null;
  const d = new Date(base + ms);
  return isNaN(d.getTime()) ? null : d;
}

function normalizeAndParseDate(raw) {
  if (!raw && raw !== 0) return null;

  // Jika sudah berupa Date object (rare), gunakan langsung
  if (raw instanceof Date) {
    return raw;
  }

  // Jika raw dari gviz berformat objek dengan 'v'/'f' tersendiri, caller sudah mengirim string/number
  let s = String(raw).trim();

  // Handle common pattern "2025-02-21 00:00:00" -> replace space to 'T' for Date.parse
  if (/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/.test(s)) {
    const d = new Date(s.replace(' ', 'T'));
    if (!isNaN(d.getTime())) return d;
  }

  // If purely numeric, try excel serial conversion
  if (/^\d+(\.\d+)?$/.test(s)) {
    const ex = tryParseExcelSerial(Number(s));
    if (ex) return ex;
  }

  // Replace localized month words with English abbreviations
  let lowered = s.toLowerCase();
  for (const k in MONTH_MAP) {
    const re = new RegExp('\\b' + k + '\\b', 'i');
    if (re.test(lowered)) {
      s = s.replace(re, MONTH_MAP[k]);
      break; // ganti sekali sudah cukup
    }
  }

  // Replace commas/dots with spaces to help parsing
  s = s.replace(/[.,]/g, ' ');

  // Try Date.parse (handles many formats like "21 Sep 2025", "Sep 21 2025", "9/21/2025", "21/9/2025" may depend on browser)
  let t = Date.parse(s);
  if (!isNaN(t)) return new Date(t);

  // Try common custom regex: dd MMM yyyy
  const m1 = s.match(/(\d{1,2})\s+([A-Za-z]{3,})\s+(\d{4})/);
  if (m1) {
    const day = parseInt(m1[1],10);
    const monStr = m1[2];
    const year = parseInt(m1[3],10);
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const monIndex = months.findIndex(x => x.toLowerCase() === monStr.toLowerCase());
    if (monIndex >= 0) return new Date(year, monIndex, day);
  }

  // Try reverse: yyyy mm dd
  const m2 = s.match(/(\d{4})[-\/\s](\d{1,2})[-\/\s](\d{1,2})/);
  if (m2) {
    const y = parseInt(m2[1],10), mo = parseInt(m2[2],10)-1, d = parseInt(m2[3],10);
    return new Date(y, mo, d);
  }

  // gagal parse
  return null;
}

function formatDateShort(d) {
  if (!d) return "";
  const day = String(d.getDate()).padStart(2,'0');
  const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const mon = months[d.getMonth()];
  const yr = d.getFullYear();
  return `${day} ${mon} ${yr}`;
}

// mapping status raw -> display + done flag
function mapStatus(raw) {
  if (raw === null || raw === undefined || String(raw).trim() === "") {
    return { display: "-", done: false, raw: raw };
  }
  const s = String(raw).trim().toLowerCase();
  const okSet = new Set(["v","✔","✓","ok","ya","yes","done","true","terkirim"]);
  if (okSet.has(s)) return { display: "OK", done: true, raw: raw };
  // kalau ada kata 'bast' di string -> anggap done
  if (s.includes("bast") || s.includes("selesai")) return { display: "OK", done: true, raw: raw };
  // else tampilkan original (uppercase) tapi treat as not done
  return { display: String(raw).toString(), done: false, raw: raw };
}

fetch(SHEET_URL)
  .then(res => res.text())
  .then(txt => {
    try {
      const json = JSON.parse(txt.substr(47).slice(0, -2));
      const rows = json.table.rows || [];

      // Auto-detect start row (index) unless START_ROW dipaksa
      let startIdx = 0;
      if (START_ROW !== null && !isNaN(Number(START_ROW))) {
        startIdx = Number(START_ROW);
      } else {
        // cari baris pertama yang nampak seperti data:
        // syarat: punya NoSurat (col 1) OR lembaga (col 2) OR tanggal (col 3)
        startIdx = 0;
        for (let i = 0; i < rows.length; i++) {
          const r = rows[i];
          const hasNo = r.c && r.c[1] && r.c[1].v && String(r.c[1].v).trim() !== "";
          const hasLemb = r.c && r.c[2] && r.c[2].v && String(r.c[2].v).trim() !== "";
          const hasTgl = r.c && r.c[3] && ( (r.c[3].f && String(r.c[3].f).trim()!=="") || (r.c[3].v && String(r.c[3].v).trim()!=="") );
          if (hasNo || hasLemb || hasTgl) { startIdx = i; break; }
        }
      }

      const dataRows = rows.slice(startIdx);

      // Debugging (bisa diliat di console)
      console.log("total rows from sheet:", rows.length, "startIdx:", startIdx, "dataRows:", dataRows.length);
      if (dataRows.length > 0) console.log("preview row 0:", dataRows[0]);

      // counters
      let totalSurat = 0; // dihitung dari tanggal berhasil parse
      let totalBAST = 0;
      let onProgress = 0;
      let lembagaSet = new Set();

      const tbody = document.querySelector("#tabelSurat tbody");
      tbody.innerHTML = "";

      // iterate dataRows
      dataRows.forEach((r, idx) => {
        // safe-get helper
        const getCell = (i) => (r.c && r.c[i] && ('v' in r.c[i] ? r.c[i].v : r.c[i])) ? r.c[i].v : (r.c && r.c[i] && r.c[i]) ? r.c[i] : null;

        const noSurat = (r.c && r.c[0] && r.c[0].v) ? r.c[0].v : "";     // col B (index 1)
        const lembagaRaw = (r.c && r.c[1] && r.c[1].v) ? r.c[1].v : "";   // col C (index 2)
        const tglRaw = (r.c && r.c[2]) ? (r.c[2].f || r.c[2].v) : "";     // col D (index 3)
        const statusRaw = (r.c && r.c[8] && r.c[8].v) ? r.c[8].v : "";    // col J (index 9)

        // parse tanggal via function yang lebih robust
        const parsedDate = normalizeAndParseDate(tglRaw);
        const tglDisplay = parsedDate ? formatDateShort(parsedDate) : (String(tglRaw||"").trim() || "");

        // map status
        const mapped = mapStatus(statusRaw);
        const statusDisplay = mapped.display;
        const isDone = mapped.done;

        // counters
        if (parsedDate) totalSurat++;
        if (isDone) totalBAST++;
        else onProgress++;

        if (lembagaRaw) lembagaSet.add(String(lembagaRaw).trim());

        // build row (noSurat, tgl, lembaga, status)
        const tr = `<tr>
          <td>${escapeHtml(noSurat)}</td>
          <td>${escapeHtml(tglDisplay)}</td>
          <td>${escapeHtml(lembagaRaw)}</td>
          <td>${escapeHtml(statusDisplay)}</td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', tr);
      });

      // update scorecards
      document.getElementById("totalLembaga").innerText = lembagaSet.size;
      document.getElementById("totalSurat").innerText = totalSurat;
      document.getElementById("totalBAST").innerText = totalBAST;
      document.getElementById("onProgress").innerText = onProgress;

    } catch (e) {
      console.error("Parse error:", e);
    }
  })
  .catch(err => console.error("Error fetch sheet:", err));

// small helper to escape HTML (safety)
function escapeHtml(s) {
  if (s === null || s === undefined) return "";
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'", "&#39;");
}
</script>

<style>
/* Tabel header & striping */
#tabelSurat thead {
  background-color: #0d6efd; /* bootstrap primary */
  color: white;
}
#tabelSurat tbody tr:nth-child(even) {
  background-color: #f2f8ff;
}
#tabelSurat tbody tr:nth-child(odd) {
  background-color: #ffffff;
}
#tabelSurat tbody tr:hover {
  background-color: #e6f2ff;
}
</style>


</body>
</html>
